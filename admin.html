<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Corte & Estilo - Painel de Administração</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <!-- SweetAlert2 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <style>
      :root {
        --primary: #0a0a0a; /* Preto profundo */
        --secondary: #d4a017; /* Dourado vintage */
        --light: #e5e5e5; /* Cinza claro para texto */
        --dark: #1c2526; /* Cinza escuro para fundos */
        --accent: #2d3748; /* Cinza médio para detalhes */
        --success: #2f855a; /* Verde escuro para confirmação */
        --danger: #c53030; /* Vermelho escuro para deletar */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, var(--dark) 0%, var(--primary) 100%);
        color: var(--light);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
        font-size: 16px;
      }

      /* Navbar */
      .navbar {
        background-color: var(--primary) !important;
        border-bottom: 2px solid var(--secondary);
        position: sticky;
        top: 0;
        z-index: 1000;
        padding: clamp(12px, 2.5vw, 15px) 0;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
      }

      .navbar-brand {
        font-weight: 700;
        color: var(--secondary) !important;
        font-size: clamp(1.5rem, 4.5vw, 2rem);
        display: flex;
        align-items: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .navbar-brand i {
        font-size: clamp(1.3rem, 4vw, 1.6rem);
      }

      .nav-link {
        color: var(--light) !important;
        font-weight: 500;
        padding: clamp(8px, 2vw, 10px) clamp(15px, 3.5vw, 20px);
        border-radius: 6px;
        transition: background-color 0.3s, color 0.3s, transform 0.2s;
        font-size: clamp(0.9rem, 2.8vw, 1.1rem);
      }

      .nav-link:hover,
      .nav-link.active {
        color: var(--secondary) !important;
        background-color: rgba(212, 160, 23, 0.15);
        transform: translateY(-1px);
      }

      /* Botão Principal */
      .btn-gold {
        background-color: var(--secondary);
        color: var(--primary);
        font-weight: 600;
        padding: clamp(10px, 2.5vw, 12px) clamp(20px, 4vw, 25px);
        border-radius: 6px;
        border: none;
        text-transform: uppercase;
        font-size: clamp(0.85rem, 2.3vw, 0.95rem);
        transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        letter-spacing: 1px;
      }

      .btn-gold:hover {
        background-color: #b8860b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      /* Painel Admin */
      .admin-panel {
        background-color: var(--dark);
        padding: clamp(20px, 5vw, 30px);
        border-radius: 10px;
        border: 1px solid rgba(212, 160, 23, 0.3);
        max-width: clamp(90%, 95vw, 1200px);
        margin: clamp(20px, 5vw, 40px) auto;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
      }

      .admin-panel h3 {
        font-size: clamp(1.6rem, 4.5vw, 2rem);
        margin-bottom: clamp(15px, 3vw, 20px);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: var(--secondary);
      }

      /* Tabela */
      .admin-table {
        width: 100%;
        border-collapse: collapse;
        font-size: clamp(0.85rem, 2.5vw, 0.95rem);
      }

      .admin-table th,
      .admin-table td {
        padding: clamp(10px, 2.5vw, 12px);
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      }

      .admin-table th {
        background-color: rgba(212, 160, 23, 0.2);
        color: var(--secondary);
        font-weight: 600;
        font-size: clamp(0.9rem, 2.8vw, 1rem);
        text-transform: uppercase;
      }

      .admin-table tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }

      /* Botões de Ação */
      .action-btn {
        padding: clamp(6px, 1.8vw, 8px) clamp(10px, 2.5vw, 12px);
        border-radius: 6px;
        font-size: clamp(0.75rem, 2.2vw, 0.85rem);
        transition: background-color 0.3s, transform 0.2s;
        margin-right: 5px;
        margin-bottom: 5px;
      }

      .btn-confirm {
        background-color: var(--success);
        color: var(--light);
        border: none;
      }

      .btn-confirm:hover {
        background-color: #276749;
        transform: translateY(-1px);
      }

      .btn-delete {
        background-color: var(--danger);
        color: var(--light);
        border: none;
      }

      .btn-delete:hover {
        background-color: #9b2c2c;
        transform: translateY(-1px);
      }

      .btn-whatsapp {
        background-color: #25D366;
        color: var(--light);
        border: none;
      }

      .btn-whatsapp:hover {
        background-color: #1ebe57;
        transform: translateY(-1px);
      }

      /* Filtros */
      .d-flex {
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      .form-control {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--light);
        border-radius: 6px;
        padding: clamp(8px, 2vw, 10px);
        font-size: clamp(0.85rem, 2.3vw, 0.95rem);
      }

      /* Responsividade */
      @media (max-width: 1200px) {
        .admin-panel {
          max-width: 95%;
        }

        .admin-table th,
        .admin-table td {
          padding: 8px;
        }
      }

      @media (max-width: 992px) {
        .navbar-nav {
          text-align: center;
          padding: 10px 0;
        }

        .nav-link {
          margin: 5px 0;
          padding: 8px 12px;
        }

        .btn-gold {
          padding: 8px 15px;
        }

        .admin-table {
          font-size: 0.9rem;
        }
      }

      @media (max-width: 768px) {
        .navbar-brand {
          font-size: 1.5rem;
        }

        .admin-panel {
          padding: 15px;
          margin: 15px;
        }

        .admin-table {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }

        .admin-table th,
        .admin-table td {
          font-size: 0.85rem;
          padding: 6px;
        }

        .action-btn {
          padding: 5px 8px;
          font-size: 0.8rem;
          display: inline-block;
          margin-bottom: 5px;
        }

        .d-flex {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }

        .form-control,
        .btn-gold,
        .btn-secondary {
          width: auto;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 576px) {
        .navbar-brand {
          font-size: 1.3rem;
        }

        .nav-link {
          font-size: 0.85rem;
          padding: 6px 10px;
        }

        .admin-panel h3 {
          font-size: 1.4rem;
        }

        .admin-table {
          display: block;
        }

        .admin-table thead {
          display: none;
        }

        .admin-table tr {
          display: flex;
          flex-wrap: wrap;
          margin-bottom: 15px;
          padding: 10px;
          background-color: rgba(255, 255, 255, 0.05);
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .admin-table td {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 10px;
          font-size: 0.85rem;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          flex: 1 1 100%;
        }

        .admin-table td::before {
          content: attr(data-label);
          font-weight: 600;
          color: var(--secondary);
          text-transform: uppercase;
          font-size: 0.8rem;
          flex: 0 0 40%;
        }

        .admin-table td:last-child {
          border-bottom: none;
        }

        .action-btn {
          width: 48%;
          text-align: center;
          margin-bottom: 8px;
        }

        .d-flex {
          flex-direction: column;
          align-items: stretch;
        }

        .form-control,
        .btn-gold,
        .btn-secondary {
          width: 100%;
          font-size: 0.85rem;
        }
      }

      @media (max-width: 400px) {
        .admin-panel {
          padding: 10px;
          margin: 10px;
        }

        .admin-table td {
          font-size: 0.8rem;
        }

        .form-control {
          font-size: 0.8rem;
        }

        .action-btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="/"><i class="fas fa-cut"></i> Corte & Estilo</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Voltar ao Site</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="login.html" onclick="logout()">Sair</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Painel Admin -->
    <div class="admin-panel">
      <h3 class="text-center mb-4">Painel de Agendamentos</h3>
      <div class="d-flex justify-content-between mb-3">
        <input type="date" id="filterDate" class="form-control w-50" />
        <div>
          <button class="btn btn-gold ms-2" onclick="loadAgendamentos()">Filtrar</button>
          <button class="btn btn-secondary ms-2" onclick="clearFilter()">Limpar Filtro</button>
        </div>
      </div>
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Telefone</th>
            <th>Serviço</th>
            <th>Barbeiro</th>
            <th>Data</th>
            <th>Horário</th>
            <th>Observações</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="agendamentosTable"></tbody>
      </table>
    </div>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      // Base URL para a API
      const API_URL = window.location.origin;

      // Elementos do DOM
      let agendamentosTable, filterDate;

      // Estado
      const token = localStorage.getItem("token");
      let lastAgendamentos = []; // Armazena a última lista de agendamentos
      const notificationSound = new Audio(
        "https://www.soundjay.com/buttons/beep-01a.mp3"
      ); // URL do som de notificação

      // Inicialização
      document.addEventListener("DOMContentLoaded", () => {
        agendamentosTable = document.getElementById("agendamentosTable");
        filterDate = document.getElementById("filterDate");

        const today = new Date().toISOString().split("T")[0];
        filterDate.value = today;

        // Verificar autenticação
        if (!token) {
          Swal.fire({
            title: "Acesso Negado",
            text: "Você precisa estar logado para acessar o painel.",
            icon: "error",
            confirmButtonText: "Ok",
            confirmButtonColor: "#d4a017",
            background: "#0a0a0a",
            color: "#e5e5e5",
          }).then(() => {
            window.location.href = "/";
          });
          return;
        }

        // Carregar agendamentos iniciais
        loadAgendamentos();

        // Verificar novos agendamentos a cada 30 segundos
        setInterval(checkNewAgendamentos, 30000);
      });

      // Carregar agendamentos
      async function loadAgendamentos() {
        try {
          let url = `${API_URL}/api/agendamentos`;
          if (filterDate.value) {
            url += `?data=${filterDate.value}`;
          }

          const response = await fetch(url, {
            headers: { Authorization: token },
          });
          const data = await response.json();

          if (data.success) {
            renderAgendamentos(data.data);
            lastAgendamentos = data.data; // Atualiza a lista de agendamentos
          } else {
            renderAgendamentos([]);
            Swal.fire({
              title: "Erro",
              text: data.message || "Erro ao carregar agendamentos.",
              icon: "error",
              confirmButtonText: "Ok",
              confirmButtonColor: "#d4a017",
              background: "#0a0a0a",
              color: "#e5e5e5",
            });
          }
        } catch (error) {
          console.error("Erro ao carregar agendamentos:", error);
          renderAgendamentos([]);
          Swal.fire({
            title: "Erro de Conexão",
            text: "Erro de conexão com o servidor. Verifique sua conexão e tente novamente.",
            icon: "error",
            confirmButtonText: "Ok",
            confirmButtonColor: "#d4a017",
            background: "#0a0a0a",
            color: "#e5e5e5",
          });
        }
      }

      // Verificar novos agendamentos
      async function checkNewAgendamentos() {
        try {
          let url = `${API_URL}/api/agendamentos`;
          if (filterDate.value) {
            url += `?data=${filterDate.value}`;
          }

          const response = await fetch(url, {
            headers: { Authorization: token },
          });
          const data = await response.json();

          if (data.success) {
            const novosAgendamentos = data.data.filter(
              (ag) => !lastAgendamentos.some((last) => last.id === ag.id)
            );

            if (novosAgendamentos.length > 0) {
              novosAgendamentos.forEach((ag) => {
                Swal.fire({
                  title: "Novo Agendamento!",
                  html: `
                    <p><strong>Nome:</strong> ${ag.nome}</p>
                    <p><strong>Serviço:</strong> ${ag.servico}</p>
                    <p><strong>Barbeiro:</strong> ${ag.barbeiro}</p>
                    <p><strong>Data:</strong> ${ag.data ? new Date(ag.data).toLocaleDateString("pt-BR") : "-"}</p>
                    <p><strong>Horário:</strong> ${ag.horario}</p>
                    <p><strong>Telefone:</strong> ${ag.telefone}</p>
                  `,
                  icon: "info",
                  confirmButtonText: "Ok",
                  confirmButtonColor: "#d4a017",
                  background: "#0a0a0a",
                  color: "#e5e5e5",
                });

                // Tocar som de notificação
                notificationSound.play().catch((error) => {
                  console.error("Erro ao tocar som de notificação:", error);
                });
              });

              renderAgendamentos(data.data);
              lastAgendamentos = data.data; // Atualiza a lista de agendamentos
            }
          }
        } catch (error) {
          console.error("Erro ao verificar novos agendamentos:", error);
        }
      }

      // Limpar filtro de data
      function clearFilter() {
        filterDate.value = "";
        loadAgendamentos();
      }

      // Renderizar agendamentos na tabela
      function renderAgendamentos(agendamentos) {
        agendamentosTable.innerHTML = "";

        if (agendamentos.length === 0) {
          agendamentosTable.innerHTML =
            '<tr><td colspan="10" class="text-center">Nenhum agendamento encontrado</td></tr>';
          return;
        }

        agendamentos.forEach((ag) => {
          const row = document.createElement("tr");
          const telefoneLimpo = ag.telefone.replace(/\D/g, ""); // Remove caracteres não numéricos
          row.innerHTML = `
            <td data-label="ID">${ag.id || "-"}</td>
            <td data-label="Nome">${ag.nome || "-"}</td>
            <td data-label="Telefone">${ag.telefone || "-"}</td>
            <td data-label="Serviço">${ag.servico || "-"}</td>
            <td data-label="Barbeiro">${ag.barbeiro || "-"}</td>
            <td data-label="Data">${ag.data ? new Date(ag.data).toLocaleDateString("pt-BR") : "-"}</td>
            <td data-label="Horário">${ag.horario || "-"}</td>
            <td data-label="Observações">${ag.observacoes || "-"}</td>
            <td data-label="Status">${ag.status || "Pendente"}</td>
            <td data-label="Ações">
              <button class="action-btn btn-confirm" onclick="confirmarAgendamento(${ag.id})" ${
                ag.status === "Confirmado" ? "disabled" : ""
              }>Confirmar</button>
              <button class="action-btn btn-delete" onclick="deletarAgendamento(${ag.id})">Deletar</button>
              <button class="action-btn btn-whatsapp" onclick="abrirWhatsApp('${telefoneLimpo}', '${ag.nome}')"><i class="fab fa-whatsapp"></i> WhatsApp</button>
            </td>
          `;
          agendamentosTable.appendChild(row);
        });
      }

      // Confirmar agendamento
      async function confirmarAgendamento(id) {
        try {
          const response = await fetch(`${API_URL}/api/agendamentos/${id}/confirmar`, {
            method: "PATCH",
            headers: { Authorization: token, "Content-Type": "application/json" },
          });
          const result = await response.json();

          if (result.success) {
            loadAgendamentos();
            Swal.fire({
              title: "Sucesso",
              text: "Agendamento confirmado com sucesso!",
              icon: "success",
              confirmButtonText: "Ok",
              confirmButtonColor: "#d4a017",
              background: "#0a0a0a",
              color: "#e5e5e5",
            });
          } else {
            Swal.fire({
              title: "Erro",
              text: result.message || "Erro ao confirmar agendamento.",
              icon: "error",
              confirmButtonText: "Ok",
              confirmButtonColor: "#d4a017",
              background: "#0a0a0a",
              color: "#e5e5e5",
            });
          }
        } catch (error) {
          console.error("Erro ao confirmar:", error);
          Swal.fire({
            title: "Erro de Conexão",
            text: "Erro de conexão com o servidor. Verifique sua conexão e tente novamente.",
            icon: "error",
            confirmButtonText: "Ok",
            confirmButtonColor: "#d4a017",
            background: "#0a0a0a",
            color: "#e5e5e5",
          });
        }
      }

      // Deletar agendamento
      async function deletarAgendamento(id) {
        const result = await Swal.fire({
          title: "Confirmar Exclusão",
          text: "Tem certeza que deseja deletar este agendamento?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Deletar",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#c53030",
          cancelButtonColor: "#6c757d",
          background: "#0a0a0a",
          color: "#e5e5e5",
        });

        if (result.isConfirmed) {
          try {
            const response = await fetch(`${API_URL}/api/agendamentos/${id}`, {
              method: "DELETE",
              headers: { Authorization: token },
            });
            const result = await response.json();

            if (result.success) {
              loadAgendamentos();
              Swal.fire({
                title: "Deletado",
                text: "Agendamento deletado com sucesso!",
                icon: "success",
                confirmButtonText: "Ok",
                confirmButtonColor: "#d4a017",
                background: "#0a0a0a",
                color: "#e5e5e5",
              });
            } else {
              Swal.fire({
                title: "Erro",
                text: result.message || "Erro ao deletar agendamento.",
                icon: "error",
                confirmButtonText: "Ok",
                confirmButtonColor: "#d4a017",
                background: "#0a0a0a",
                color: "#e5e5e5",
              });
            }
          } catch (error) {
            console.error("Erro ao deletar:", error);
            Swal.fire({
              title: "Erro de Conexão",
              text: "Erro de conexão com o servidor. Verifique sua conexão e tente novamente.",
              icon: "error",
              confirmButtonText: "Ok",
              confirmButtonColor: "#d4a017",
              background: "#0a0a0a",
              color: "#e5e5e5",
            });
          }
        }
      }

      // Abrir WhatsApp
      function abrirWhatsApp(telefone, nome) {
        const mensagem = encodeURIComponent(`Olá, ${nome}, sobre seu agendamento na Corte & Estilo...`);
        const url = `https://api.whatsapp.com/send?phone=+55${telefone}&text=${mensagem}`;
        window.open(url, "_blank");
      }

      // Logout
      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/";
      }
    </script>
  </body>
</html>